---
description: Best practices for integrating and using the Sentry SDK for error monitoring, context enrichment, and data hygiene.
globs:
  - "**/*.ts"
  - "**/*.tsx"
  - "**/*.js"
  - "**/*.jsx"
alwaysApply: false
---

# Sentry Integration Best Practices

## Initialization

- Initialize Sentry as early as possible in the application lifecycle — before any other imports or framework bootstrapping.
  - In Node.js: call `Sentry.init()` at the very top of your entry file, before importing routes or middleware.
  - In Next.js: use `sentry.client.config.ts` and `sentry.server.config.ts` (or the `instrumentation.ts` hook) so initialization runs before page/route code.
  - In React SPAs: call `Sentry.init()` before `ReactDOM.createRoot()`.

```ts
// Example: Node.js entry point
import * as Sentry from "@sentry/node";

Sentry.init({
  dsn: process.env.SENTRY_DSN,
  environment: process.env.NODE_ENV,
  release: process.env.SENTRY_RELEASE,
  tracesSampleRate: process.env.NODE_ENV === "production" ? 0.2 : 1.0,
});

// All other imports AFTER Sentry.init()
import express from "express";
```

## DSN Configuration

- **Never** hard-code the Sentry DSN in source code. Always read it from an environment variable (`SENTRY_DSN`).
- Keep DSNs different per environment (development, staging, production) to avoid polluting production data with local errors.
- Validate that `SENTRY_DSN` is set at startup; log a warning if it is missing so issues are caught early.

## Sample Rates

- Set `tracesSampleRate` to a value appropriate for the environment:
  - **Development / staging**: `1.0` (capture everything for full visibility).
  - **Production**: `0.1`–`0.3` for most workloads; adjust based on traffic volume and budget.
- Use `tracesSampler` for dynamic sampling when you need different rates per transaction:

```ts
Sentry.init({
  tracesSampler: (samplingContext) => {
    if (samplingContext.name?.includes("/health")) return 0;
    if (samplingContext.name?.includes("/api/checkout")) return 1.0;
    return 0.2;
  },
});
```

## Breadcrumbs

- Add custom breadcrumbs before critical operations to provide extra debugging context:

```ts
Sentry.addBreadcrumb({
  category: "auth",
  message: `User ${userId} attempted login`,
  level: "info",
  data: { method: "oauth", provider: "github" },
});
```

- Avoid logging sensitive data (passwords, tokens, PII) in breadcrumb messages or data fields.
- Sentry auto-captures console logs, XHR/fetch, and DOM clicks as breadcrumbs — disable categories you do not need via `beforeBreadcrumb`.

## User Context

- Set user context immediately after authentication so every subsequent event is tied to the user:

```ts
Sentry.setUser({
  id: user.id,
  email: user.email,
  username: user.username,
});
```

- Clear user context on logout: `Sentry.setUser(null)`.
- Never include passwords, tokens, or full credit card numbers in user context.

## Capturing Errors with Context

- When catching errors, always forward them to Sentry with additional context:

```ts
try {
  await processOrder(orderId);
} catch (error) {
  Sentry.captureException(error, {
    tags: { module: "orders", orderId },
    extra: { payload: sanitizedPayload },
    level: "error",
  });
  throw error; // re-throw if the caller needs to handle it
}
```

- Use **tags** for indexed, searchable key-value pairs (low cardinality).
- Use **extra** for arbitrary debug data that does not need to be searchable.
- Use **contexts** for structured data blocks (e.g., device info, order details).

## Scoped Context with `Sentry.withScope`

- Use `Sentry.withScope` when you need temporary context that should not leak to other events:

```ts
Sentry.withScope((scope) => {
  scope.setTag("transaction_type", "refund");
  scope.setExtra("refundDetails", { amount, reason });
  scope.setLevel("warning");
  Sentry.captureMessage("Refund processed with warnings");
});
```

## Source Maps

- Upload source maps as part of your build/deploy pipeline so stack traces in Sentry show original source code.
- Use `@sentry/webpack-plugin`, `@sentry/vite-plugin`, or `sentry-cli` to upload source maps tied to a release.
- **Do not** serve source maps publicly; upload them to Sentry and exclude them from the production bundle.

```js
// Example: Vite plugin
import { sentryVitePlugin } from "@sentry/vite-plugin";

export default defineConfig({
  build: { sourcemap: true },
  plugins: [
    sentryVitePlugin({
      org: process.env.SENTRY_ORG,
      project: process.env.SENTRY_PROJECT,
      authToken: process.env.SENTRY_AUTH_TOKEN,
    }),
  ],
});
```

## Filtering Sensitive Data with `beforeSend`

- Use the `beforeSend` hook to scrub PII, secrets, or noisy errors before they leave the client:

```ts
Sentry.init({
  beforeSend(event) {
    // Drop events from browser extensions
    if (event.exception?.values?.some((e) =>
      e.stacktrace?.frames?.some((f) => f.filename?.includes("extensions://"))
    )) {
      return null;
    }

    // Scrub sensitive headers
    if (event.request?.headers) {
      delete event.request.headers["Authorization"];
      delete event.request.headers["Cookie"];
    }

    return event;
  },
});
```

- Use `beforeSendTransaction` to filter or modify transaction events similarly.

## React Error Boundaries

- Wrap your application (or key subtrees) with `Sentry.ErrorBoundary` to catch rendering errors:

```tsx
import * as Sentry from "@sentry/react";

function App() {
  return (
    <Sentry.ErrorBoundary
      fallback={({ error, resetError }) => (
        <ErrorFallback error={error} onReset={resetError} />
      )}
      showDialog
    >
      <MainApp />
    </Sentry.ErrorBoundary>
  );
}
```

- For granular control, create custom error boundaries that call `Sentry.captureException` in `componentDidCatch`.

## Environment and Release Tags

- Always set `environment` (e.g., `"production"`, `"staging"`, `"development"`) in `Sentry.init()` to segment events.
- Always set `release` to a unique identifier (git SHA or semantic version) so you can correlate errors with deployments:

```ts
Sentry.init({
  environment: process.env.NODE_ENV,
  release: `myapp@${process.env.COMMIT_SHA}`,
});
```

- Use Sentry Releases to track which deploy introduced a regression and to associate commits and source maps.
