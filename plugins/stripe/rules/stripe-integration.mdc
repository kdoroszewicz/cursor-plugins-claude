---
description: Best practices for Stripe payment integration — SDK usage, error handling, PCI compliance, and API patterns
globs:
  - "**/*.ts"
  - "**/*.js"
  - "**/*.tsx"
  - "**/*.jsx"
alwaysApply: false
---

# Stripe Integration Best Practices

## SDK Usage

- **Always use the official Stripe SDK** (`stripe` npm package) instead of raw HTTP requests. The SDK handles authentication, retries, serialization, and type safety automatically.

```typescript
// ✅ Correct — use the Stripe SDK
import Stripe from 'stripe';
const stripe = new Stripe(process.env.STRIPE_SECRET_KEY!, {
  apiVersion: '2024-12-18.acacia',
  typescript: true,
});

// ❌ Incorrect — never use raw HTTP for Stripe API calls
fetch('https://api.stripe.com/v1/charges', { ... });
```

## Idempotency Keys

- **Always use idempotency keys for mutation operations** (create, update, delete). This prevents duplicate charges and ensures safe retries.

```typescript
const paymentIntent = await stripe.paymentIntents.create(
  {
    amount: 2000,
    currency: 'usd',
    customer: customerId,
    metadata: { orderId: order.id },
  },
  {
    idempotencyKey: `pi_create_${order.id}`,
  }
);
```

## Webhook Signature Verification

- **Always validate webhook signatures** using `stripe.webhooks.constructEvent()`. Never trust raw webhook payloads without signature verification.

```typescript
const event = stripe.webhooks.constructEvent(
  request.body,        // raw body (Buffer or string)
  request.headers['stripe-signature']!,
  process.env.STRIPE_WEBHOOK_SECRET!
);
```

## Error Handling

- **Handle all Stripe error types explicitly.** Each error type indicates a different failure mode and requires a different response.

```typescript
try {
  const charge = await stripe.charges.create({ ... });
} catch (err) {
  if (err instanceof Stripe.errors.StripeCardError) {
    // Card was declined — inform the customer
    console.error(`Card declined: ${err.message} (code: ${err.code})`);
  } else if (err instanceof Stripe.errors.StripeRateLimitError) {
    // Too many requests — back off and retry
    console.error('Rate limit hit, retrying...');
  } else if (err instanceof Stripe.errors.StripeInvalidRequestError) {
    // Invalid parameters — fix the request
    console.error(`Invalid request: ${err.message}`);
  } else if (err instanceof Stripe.errors.StripeAuthenticationError) {
    // Invalid API key — check configuration
    console.error('Authentication failed — check STRIPE_SECRET_KEY');
  } else if (err instanceof Stripe.errors.StripeAPIError) {
    // Stripe internal error — retry with backoff
    console.error('Stripe API error, retrying...');
  } else if (err instanceof Stripe.errors.StripeConnectionError) {
    // Network error — retry with backoff
    console.error('Connection to Stripe failed, retrying...');
  } else {
    // Unknown error
    console.error('Unexpected error:', err);
  }
}
```

## Metadata for Tracking

- **Always attach metadata** to Stripe objects (customers, payment intents, subscriptions) for tracking and reconciliation. Metadata makes it easy to correlate Stripe objects with your internal records.

```typescript
const customer = await stripe.customers.create({
  email: user.email,
  metadata: {
    userId: user.id,
    source: 'web_signup',
    plan: 'pro',
  },
});
```

## Test Mode Keys

- **Always use test mode keys (`sk_test_*`, `pk_test_*`) in development** and staging environments. Never use live keys outside of production.

```typescript
// Use environment variables — never hardcode keys
const stripe = new Stripe(process.env.STRIPE_SECRET_KEY!);

// Validate key prefix in non-production environments
if (process.env.NODE_ENV !== 'production') {
  if (!process.env.STRIPE_SECRET_KEY?.startsWith('sk_test_')) {
    throw new Error('Use test mode Stripe keys in non-production environments');
  }
}
```

## PCI Compliance

- **Never handle raw card numbers on your server.** Use Stripe Elements, Checkout, or Payment Links to collect card details securely on the client side.
- **Never log full card numbers, CVVs, or other sensitive payment details.** Use Stripe's tokenization to handle sensitive data.

```typescript
// ✅ Correct — use PaymentIntent with client-side confirmation
const paymentIntent = await stripe.paymentIntents.create({
  amount: 2000,
  currency: 'usd',
  automatic_payment_methods: { enabled: true },
});
// Send paymentIntent.client_secret to the frontend

// ❌ Incorrect — never accept raw card numbers on the server
app.post('/charge', (req, res) => {
  const { cardNumber, cvv, expiry } = req.body; // NEVER DO THIS
});
```

## Expand Parameters

- **Use `expand` parameters** to include related objects in a single API call, reducing the number of round-trips to the Stripe API.

```typescript
// ✅ Fetch subscription with expanded customer and latest invoice in one call
const subscription = await stripe.subscriptions.retrieve(subscriptionId, {
  expand: ['customer', 'latest_invoice', 'latest_invoice.payment_intent'],
});

// Access expanded objects directly
const customerEmail = (subscription.customer as Stripe.Customer).email;
const invoiceStatus = (subscription.latest_invoice as Stripe.Invoice).status;
```

## Retry Logic

- **Implement proper retry logic** with exponential backoff for transient failures. The Stripe SDK has built-in retry support.

```typescript
const stripe = new Stripe(process.env.STRIPE_SECRET_KEY!, {
  apiVersion: '2024-12-18.acacia',
  maxNetworkRetries: 3, // SDK handles retries with exponential backoff
  timeout: 30000,       // 30-second timeout
});
```

## Currency Handling

- **Always specify amounts in the smallest currency unit** (e.g., cents for USD). Stripe expects amounts as integers, not floats.

```typescript
// ✅ Correct — amount in cents
const paymentIntent = await stripe.paymentIntents.create({
  amount: 1999, // $19.99
  currency: 'usd',
});

// ❌ Incorrect — never use floats or dollar amounts
const paymentIntent = await stripe.paymentIntents.create({
  amount: 19.99, // WRONG — Stripe expects cents
  currency: 'usd',
});
```

## Environment Variable Naming

- Use consistent environment variable names for Stripe configuration:
  - `STRIPE_SECRET_KEY` — Server-side secret key
  - `STRIPE_PUBLISHABLE_KEY` — Client-side publishable key
  - `STRIPE_WEBHOOK_SECRET` — Webhook endpoint signing secret
  - `STRIPE_PRICE_ID` — Default price ID (if applicable)
